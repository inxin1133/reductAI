version: '3.8'

services:
  # Frontend Service (Vite + React)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - .:/app
      - /app/node_modules
    # NOTE:
    # /app/node_modules is a Docker volume for dev performance.
    # When package.json changes, that volume can become stale; install deps on container start.
    command: sh -c "npm ci --no-audit --no-fund || npm install --no-audit --no-fund; npm run dev -- --host"
    environment:
      - VITE_API_BASE_URL=http://localhost:3001
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USER_SERVICE_URL=http://user-service:3002
      - TENANT_SERVICE_URL=http://tenant-service:3003
      - I18N_SERVICE_URL=http://i18n-service:3006
      - AI_AGENT_SERVICE_URL=http://ai-agent-service:3007
      - POST_SERVICE_URL=http://post-service:3005
    depends_on:
      - auth-service
      - i18n-service
      - ai-agent-service
      - post-service
    networks:
      - reduct-network

  # Auth Microservice
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    volumes:
      - ./services/auth-service/src:/app/src
    environment:
      - PORT=3001
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

  # i18n Microservice
  i18n-service:
    build:
      context: ./services/i18n-service
      dockerfile: Dockerfile
    ports:
      - "3006:3006"
    volumes:
      - ./services/i18n-service/src:/app/src
    environment:
      - PORT=3006
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

  # User Microservice
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    volumes:
      - ./services/user-service/src:/app/src
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

  # Tenant Microservice
  tenant-service:
    build:
      context: ./services/tenant-service
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    volumes:
      - ./services/tenant-service/src:/app/src
    environment:
      - PORT=3003
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

  # AI Agent / Model Management Service
  ai-agent-service:
    build:
      context: ./services/ai-agent-service
      dockerfile: Dockerfile
    ports:
      - "3007:3007"
    volumes:
      # 개발 편의: dist 기반(start) 대신 src 기반(dev)으로 실행해서
      # 라우트 추가/수정(예: /api/ai/chat)이 즉시 반영되도록 합니다.
      - ./services/ai-agent-service:/app
      - /app/node_modules
    command: npm run dev
    environment:
      - PORT=3007
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

  # Post / Block Editor Service
  post-service:
    build:
      context: ./services/post-service
      dockerfile: Dockerfile
    ports:
      - "3005:3005"
    volumes:
      - ./services/post-service:/app
      - /app/node_modules
    command: npm run dev
    environment:
      - PORT=3005
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - JWT_SECRET=${JWT_SECRET}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - reduct-network

networks:
  reduct-network:
    driver: bridge
